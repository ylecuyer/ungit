{"version":3,"file":"ungit","sources":["../source/main.js"],"sourcesContent":["var $ = require('jquery');\njQuery = $; // this is for old backward compatability of bootrap modules\nvar ko = require('knockout');\nvar dndPageScroll = require('dnd-page-scroll');\nrequire('./bootstrap');\nrequire('./jquery-ui');\nrequire('./knockout-bindings');\nconst winston = require('winston');\nungit.logger = winston.createLogger({\n  level: ungit.config.logLevel || 'error',\n  format: winston.format.combine(\n    winston.format.timestamp(),\n    winston.format.colorize(),\n    winston.format.printf((info) => {\n      const splat = info[Symbol.for('splat')];\n      if (splat) {\n        const splatStr = splat.map((arg) => JSON.stringify(arg)).join('\\n');\n        return `${info.timestamp} - ${info.level}: ${info.message} ${splatStr}`;\n      }\n      return `${info.timestamp} - ${info.level}: ${info.message}`;\n    })\n  ),\n  transports: [new winston.transports.Console()],\n});\nvar components = require('ungit-components');\nvar Server = require('./server');\nvar programEvents = require('ungit-program-events');\nvar navigation = require('ungit-navigation');\nvar adBlocker = require('just-detect-adblock');\n\n// Request animation frame polyfill and init tooltips\n(function () {\n  var lastTime = 0;\n  var vendors = ['ms', 'moz', 'webkit', 'o'];\n  for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {\n    window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];\n    window.cancelAnimationFrame =\n      window[vendors[x] + 'CancelAnimationFrame'] ||\n      window[vendors[x] + 'CancelRequestAnimationFrame'];\n  }\n\n  if (!window.requestAnimationFrame)\n    window.requestAnimationFrame = function (callback) {\n      var currTime = new Date().getTime();\n      var timeToCall = Math.max(0, 16 - (currTime - lastTime));\n      var id = window.setTimeout(function () {\n        callback(currTime + timeToCall);\n      }, timeToCall);\n      lastTime = currTime + timeToCall;\n      return id;\n    };\n\n  if (!window.cancelAnimationFrame)\n    window.cancelAnimationFrame = function (id) {\n      clearTimeout(id);\n    };\n\n  $(document).tooltip({\n    selector: '[data-toggle=\"tooltip\"]',\n  });\n})();\n\nfunction WindowTitle() {\n  this.path = 'ungit';\n  this.crash = false;\n}\nWindowTitle.prototype.update = function () {\n  var title = this.path\n    .replace(/\\\\/g, '/')\n    .split('/')\n    .filter(function (x) {\n      return x;\n    })\n    .reverse()\n    .join(' < ');\n  if (this.crash) title = ':( ungit crash ' + title;\n  document.title = title;\n};\n\nvar windowTitle = new WindowTitle();\nwindowTitle.update();\n\nvar AppContainerViewModel = function () {\n  this.content = ko.observable();\n};\nexports.AppContainerViewModel = AppContainerViewModel;\nAppContainerViewModel.prototype.templateChooser = function (data) {\n  if (!data) return '';\n  return data.template;\n};\n\nvar app, appContainer, server;\n\nexports.start = function () {\n  server = new Server();\n  appContainer = new AppContainerViewModel();\n  ungit.server = server;\n  app = components.create('app', { appContainer: appContainer, server: server });\n  ungit.__app = app;\n  programEvents.add(async (event) => {\n    ungit.logger.info(`received event: ${event.event}`);\n    if (event.event == 'disconnected' || event.event == 'git-crash-error') {\n      console.error(`ungit crash: ${event.event}`, event.error, event.stacktrace);\n      const err =\n        event.event == 'disconnected' && (await adBlocker.detectAnyAdblocker())\n          ? 'adblocker'\n          : event.event;\n      appContainer.content(components.create('crash', err));\n      windowTitle.crash = true;\n      windowTitle.update();\n    } else if (event.event == 'connected') {\n      appContainer.content(app);\n      windowTitle.crash = false;\n      windowTitle.update();\n    }\n\n    app.onProgramEvent(event);\n  });\n  if (ungit.config.authentication) {\n    var authenticationScreen = components.create('login', { server: server });\n    appContainer.content(authenticationScreen);\n    authenticationScreen.loggedIn.add(function () {\n      server.initSocket();\n    });\n  } else {\n    server.initSocket();\n  }\n\n  Raven.TraceKit.report.subscribe(function (event, err) {\n    programEvents.dispatch({ event: 'raven-crash', error: err || event.event });\n  });\n\n  var prevTimestamp = 0;\n  var updateAnimationFrame = function (timestamp) {\n    var delta = timestamp - prevTimestamp;\n    prevTimestamp = timestamp;\n    if (app.updateAnimationFrame) app.updateAnimationFrame(delta);\n    window.requestAnimationFrame(updateAnimationFrame);\n  };\n  window.requestAnimationFrame(updateAnimationFrame);\n\n  ko.applyBindings(appContainer);\n\n  // routing\n  navigation.crossroads.addRoute('/', function () {\n    app.content(components.create('home', { app: app }));\n    windowTitle.path = 'ungit';\n    windowTitle.update();\n  });\n\n  navigation.crossroads.addRoute('/repository{?query}', function (query) {\n    programEvents.dispatch({ event: 'navigated-to-path', path: query.path });\n    app.content(components.create('path', { server: server, path: query.path }));\n    windowTitle.path = query.path;\n    windowTitle.update();\n  });\n\n  navigation.init();\n};\n\n$(document).ready(function () {\n  dndPageScroll.default(); // Automatic page scrolling on drag-n-drop: http://www.planbox.com/blog/news/updates/html5-drag-and-drop-scrolling-the-page.html\n});\n"],"names":[],"mappings":"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"}